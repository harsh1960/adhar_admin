<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin - Card Maker Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    /* ================= CSS RESET & VARIABLES ================= */
    :root {
        --primary: #2563eb;
        --secondary: #1e293b;
        --bg: #f1f5f9;
        --surface: #ffffff;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --text-main: #0f172a;
        --text-light: #64748b;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background: var(--bg); display: flex; min-height: 100vh; color: var(--text-main); }

    /* ================= SIDEBAR ================= */
    .sidebar {
        width: 260px; background: var(--secondary); color: white;
        display: flex; flex-direction: column; padding: 25px;
        position: fixed; height: 100vh; z-index: 10;
    }
    .brand { font-size: 22px; font-weight: 700; margin-bottom: 40px; display: flex; align-items: center; gap: 12px; color: #fff; }
    .menu-item {
        padding: 14px 16px; margin-bottom: 8px; border-radius: 8px;
        cursor: pointer; transition: 0.2s; color: #94a3b8; font-weight: 500;
        display: flex; align-items: center; gap: 12px;
    }
    .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); color: white; }

    /* ================= MAIN CONTENT ================= */
    .main { margin-left: 260px; flex: 1; padding: 30px; width: calc(100% - 260px); }
    
    /* Stats Cards */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 35px; }
    .stat-card {
        background: var(--surface); padding: 25px; border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between;
    }
    .stat-info h3 { font-size: 32px; font-weight: 700; color: var(--text-main); margin-bottom: 5px; }
    .stat-info p { color: var(--text-light); font-size: 14px; font-weight: 500; }
    .stat-icon { width: 55px; height: 55px; border-radius: 12px; display: grid; place-items: center; font-size: 24px; }

    /* Section Headers */
    .section-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: var(--secondary); display: flex; align-items: center; gap: 10px; }
    
    /* Pending Requests Grid */
    .pending-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .req-card {
        background: white; padding: 20px; border-radius: 12px; border-left: 5px solid var(--warning);
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
    }
    .req-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .utr-badge { background: #f1f5f9; padding: 5px 10px; border-radius: 6px; font-family: monospace; font-size: 14px; font-weight: bold; border: 1px solid #e2e8f0; }
    
    /* Plan Selector in Pending Card */
    .plan-select {
        width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;
        margin: 15px 0 10px 0; font-size: 13px; background-color: #f8fafc;
    }

    .req-actions { display: flex; gap: 10px; margin-top: 10px; }

    /* Data Table */
    .table-container { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow-x: auto; }
    .search-bar { width: 100%; padding: 12px 15px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 20px; outline: none; transition: 0.2s; }
    .search-bar:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    th { text-align: left; padding: 15px; border-bottom: 2px solid #f1f5f9; color: var(--text-light); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    td { padding: 15px; border-bottom: 1px solid #f1f5f9; color: var(--text-main); font-size: 14px; vertical-align: middle; }
    
    .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; display: inline-block; }
    .status-premium { background: #dcfce7; color: #166534; }
    .status-free { background: #f1f5f9; color: #475569; }
    .status-expired { background: #fee2e2; color: #991b1b; }
    
    .usage-badge { 
        background: #eff6ff; color: #1e40af; padding: 4px 8px; 
        border-radius: 4px; font-weight: 600; font-size: 12px; 
    }

    /* Buttons */
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; color: white; transition: 0.2s; }
    .btn:active { transform: scale(0.95); }
    .btn-approve { background: var(--success); width: 100%; }
    .btn-reject { background: var(--danger); width: 100%; }
    
    .action-btn { width: 32px; height: 32px; border-radius: 6px; display: inline-grid; place-items: center; border:none; cursor: pointer; margin-right: 5px; }
    .btn-edit { background: var(--secondary); color: white; }
    .btn-reset { background: #3b82f6; color: white; } /* Reset Count Button */
    .btn-trash { background: #fee2e2; color: #ef4444; }

    /* Modal */
    .modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(15, 23, 42, 0.6); display: none; align-items: center; justify-content: center; z-index: 100;
        backdrop-filter: blur(4px);
    }
    .modal-box { background: white; padding: 30px; width: 450px; border-radius: 16px; animation: popUp 0.3s ease; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    @keyframes popUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-size: 13px; font-weight: 600; color: var(--text-light); }
    .form-input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; outline: none; }

    @media (max-width: 768px) {
        .sidebar { display: none; }
        .main { margin-left: 0; width: 100%; padding: 15px; }
        .stats-grid { grid-template-columns: 1fr; }
    }
</style>
</head>
<body>

<div class="sidebar">
    <div class="brand"><i class="fas fa-id-card-alt"></i> Card Admin</div>
    <div class="menu-item active"><i class="fas fa-chart-pie"></i> Dashboard</div>
    <div class="menu-item"><i class="fas fa-users-cog"></i> Management</div>
</div>

<div class="main">
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-info"><h3 id="statTotal">0</h3><p>Total Users</p></div>
            <div class="stat-icon" style="background:#eff6ff; color:#2563eb;"><i class="fas fa-users"></i></div>
        </div>
        <div class="stat-card">
            <div class="stat-info"><h3 id="statPremium">0</h3><p>Active Premium</p></div>
            <div class="stat-icon" style="background:#dcfce7; color:#16a34a;"><i class="fas fa-crown"></i></div>
        </div>
        <div class="stat-card">
            <div class="stat-info"><h3 id="statPending">0</h3><p>Pending Requests</p></div>
            <div class="stat-icon" style="background:#fff7ed; color:#ea580c;"><i class="fas fa-file-invoice-dollar"></i></div>
        </div>
    </div>

    <h3 class="section-title"><i class="fas fa-clock"></i> Pending Approvals</h3>
    <div id="pendingContainer" class="pending-grid">
        </div>

    <h3 class="section-title" style="margin-top: 40px;"><i class="fas fa-list"></i> All Users Database</h3>
    <div class="table-container">
        <input type="text" id="searchInput" class="search-bar" placeholder="Search by email..." onkeyup="filterUsers()">
        <table>
            <thead>
                <tr>
                    <th>User / UID</th>
                    <th>Last Active</th>
                    <th>Status / Plan</th>
                    <th>Daily Usage</th> <th>Expires</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <tr><td colspan="6" style="text-align:center; padding:30px; color:#94a3b8;">Loading data...</td></tr>
            </tbody>
        </table>
    </div>

</div>

<div id="editModal" class="modal">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="color:var(--secondary);">Edit User</h3>
            <button onclick="closeModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        
        <input type="hidden" id="editUid">
        
        <div class="form-group">
            <label>Email</label>
            <input id="editEmail" class="form-input" disabled style="background:#f8fafc; color:#64748b;">
        </div>

        <div class="form-group">
            <label>Plan Type</label>
            <select id="editPlan" class="form-input" onchange="toggleDateInput()">
                <option value="free">Free / Expired (2/day)</option>
                <option value="standard_1m">Standard 1 Month (20/day)</option>
                <option value="professional_1m">Professional 1 Month (60/day)</option>
                <option value="standard_3m">Standard 3 Months (20/day)</option>
                <option value="professional_3m">Professional 3 Months (60/day)</option>
            </select>
        </div>

        <div class="form-group" id="dateGroup" style="display:none;">
            <label>Premium Expiry Date</label>
            <input type="date" id="editDate" class="form-input">
        </div>

        <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:30px;">
            <button onclick="closeModal()" class="btn" style="background:#e2e8f0; color:#475569;">Cancel</button>
            <button onclick="saveUserChanges()" class="btn" style="background:var(--primary);">Save Changes</button>
        </div>
    </div>
</div>

<script type="module">
  // CONFIG FOR: adhar-69f3d
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getFirestore, collection, query, onSnapshot, doc, updateDoc, deleteDoc, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCI_dvMEF9Oo5iRF42lCh9jO_53Tz4r21M",
    authDomain: "adhar-69f3d.firebaseapp.com",
    projectId: "adhar-69f3d",
    storageBucket: "adhar-69f3d.firebasestorage.app",
    messagingSenderId: "967287764155",
    appId: "1:967287764155:web:87f52e450bac6a5ec4259e"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let globalUsers = []; 

  // Limit Dictionary for Display
  const LIMIT_MAP = {
      "free": 2,
      "standard_1m": 20, "standard_3m": 20,
      "professional_1m": 60, "professional_3m": 60
  };

  // --- REALTIME LISTENER ---
  const q = query(collection(db, "users"), orderBy("lastActive", "desc"));

  onSnapshot(q, (snapshot) => {
      const users = [];
      let pendingCount = 0;
      let premiumCount = 0;
      const now = Date.now();

      snapshot.forEach(docSnap => {
          const data = docSnap.data();
          data.uid = docSnap.id;
          
          // Data Formatting
          data.lastActiveVal = (data.lastActive && data.lastActive.toDate) ? data.lastActive.toDate() : null;
          data.subExpiryVal = typeof data.subscriptionExpiry === 'number' ? data.subscriptionExpiry : 0;
          data.currentPlan = (data.subExpiryVal > now && data.planId) ? data.planId : "free";
          data.limit = LIMIT_MAP[data.currentPlan] || 2;
          
          // Lazy Reset Check for Admin View
          // We don't reset DB here to save writes, just show 0 if date mismatch
          const todayStr = new Date().toLocaleDateString("en-US", {timeZone: "Asia/Kolkata"});
          if(data.lastGenerationDate !== todayStr) {
              data.displayUsage = 0; 
          } else {
              data.displayUsage = data.cardsGeneratedToday || 0;
          }

          users.push(data);

          if(data.paymentStatus === 'pending') pendingCount++;
          if(data.subExpiryVal > now) premiumCount++;
      });

      globalUsers = users;
      updateStats(users.length, premiumCount, pendingCount);
      renderPending(users);
      renderTable(users);
  });

  // --- UI RENDERERS ---
  function updateStats(total, prem, pend) {
      document.getElementById("statTotal").innerText = total;
      document.getElementById("statPremium").innerText = prem;
      document.getElementById("statPending").innerText = pend;
  }

  function timeAgo(date) {
      if(!date) return '<span style="color:#cbd5e1;">Never</span>';
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return '<span style="color:#10b981; font-weight:bold;">Just now</span>';
      const intervals = {y:31536000, m:2592000, d:86400, h:3600, min:60};
      for(let key in intervals) {
          let count = Math.floor(seconds / intervals[key]);
          if (count > 0) return count + key + " ago";
      }
  }

  function renderPending(users) {
      const container = document.getElementById("pendingContainer");
      container.innerHTML = "";
      
      const pendingUsers = users.filter(u => u.paymentStatus === "pending");

      if(pendingUsers.length === 0) {
          container.innerHTML = '<div style="color:#94a3b8; font-style:italic; grid-column:1/-1; padding:20px; background:white; border-radius:12px; text-align:center;">No pending requests.</div>';
          return;
      }

      pendingUsers.forEach(u => {
          const card = document.createElement("div");
          card.className = "req-card";
          
          card.innerHTML = `
              <div class="req-header">
                  <strong>${u.email}</strong>
                  <span class="utr-badge">${u.utrNumber || 'No UTR'}</span>
              </div>
              <div style="font-size:12px; color:#64748b;">
                  Submitted: ${u.submittedAt ? new Date(u.submittedAt).toLocaleString() : 'N/A'}
              </div>
              
              <select id="approve-plan-${u.uid}" class="plan-select">
                  <option value="standard_1m">Standard 1 Month (₹199)</option>
                  <option value="professional_1m" selected>Professional 1 Month (₹349)</option>
                  <option value="standard_3m">Standard 3 Months (₹549)</option>
                  <option value="professional_3m">Professional 3 Months (₹899)</option>
              </select>

              <div class="req-actions">
                  <button class="btn btn-approve" onclick="handlePayment('${u.uid}', true, '${u.email}')">Approve</button>
                  <button class="btn btn-reject" onclick="handlePayment('${u.uid}', false)">Reject</button>
              </div>
          `;
          container.appendChild(card);
      });
  }

  function renderTable(users) {
      const tbody = document.getElementById("userTableBody");
      tbody.innerHTML = "";

      users.forEach(u => {
          const isPremium = u.subExpiryVal > Date.now();
          
          let badgeClass = isPremium ? "status-premium" : "status-free";
          let statusText = isPremium ? "Premium" : "Free";
          if(u.paymentStatus === 'pending') { badgeClass = "status-expired"; statusText = "Pending"; }

          // Clean Plan Name
          const planName = u.currentPlan.replace('_', ' ').toUpperCase();
          
          const expiryDate = isPremium ? new Date(u.subExpiryVal).toLocaleDateString() : "-";
          const lastActiveStr = timeAgo(u.lastActiveVal);

          const tr = document.createElement("tr");
          tr.innerHTML = `
              <td>
                  <div style="font-weight:600;">${u.email}</div>
                  <div style="font-size:11px; color:#94a3b8;">UID: ${u.uid}</div>
              </td>
              <td class="last-active">${lastActiveStr}</td>
              <td>
                  <span class="status-badge ${badgeClass}">${statusText}</span>
                  <div style="font-size:11px; margin-top:4px; color:#64748b;">${planName}</div>
              </td>
              <td>
                  <span class="usage-badge">${u.displayUsage} / ${u.limit}</span>
              </td>
              <td style="font-weight:500;">${expiryDate}</td>
              <td>
                  <button class="action-btn btn-edit" title="Edit Plan" onclick="openEditModal('${u.uid}')"><i class="fas fa-pen"></i></button>
                  <button class="action-btn btn-reset" title="Reset Daily Limit" onclick="resetLimit('${u.uid}')"><i class="fas fa-sync-alt"></i></button>
                  <button class="action-btn btn-trash" title="Delete User" onclick="deleteUser('${u.uid}')"><i class="fas fa-trash"></i></button>
              </td>
          `;
          tbody.appendChild(tr);
      });
  }

  // --- ACTIONS ---

  // 1. APPROVE LOGIC (Calculates Dates based on Plan)
  window.handlePayment = async (uid, isApproved, email) => {
      if(isApproved) {
          const planSelect = document.getElementById(`approve-plan-${uid}`);
          const planId = planSelect.value;
          
          if(!confirm(`Approve ${email} for plan: ${planId}?`)) return;

          // Calculate Duration
          let durationDays = 30; // Default 1m
          if (planId.includes('3m')) durationDays = 90;
          if (planId.includes('1y')) durationDays = 365;

          const newExpiry = Date.now() + (durationDays * 24 * 60 * 60 * 1000);

          await updateDoc(doc(db, "users", uid), {
              paymentStatus: "approved",
              subscriptionExpiry: newExpiry,
              planId: planId, // Important: Sets the limit
              approvedAt: Date.now(),
              cardsGeneratedToday: 0 // Reset usage on upgrade
          });
      } else {
          if(!confirm("Reject this request?")) return;
          await updateDoc(doc(db, "users", uid), { paymentStatus: "rejected", rejectedAt: Date.now() });
      }
  };

  // 2. RESET LIMIT (Emergency)
  window.resetLimit = async (uid) => {
      if(!confirm("Reset this user's daily card count to 0?")) return;
      await updateDoc(doc(db, "users", uid), { cardsGeneratedToday: 0 });
      // Note: We don't change the date, just the count, so they can make more today.
  };

  window.deleteUser = async (uid) => {
      if(confirm("Permanently delete this user?")) await deleteDoc(doc(db, "users", uid));
  };

  // --- EDIT MODAL LOGIC ---
  window.openEditModal = (uid) => {
      const user = globalUsers.find(u => u.uid === uid);
      if(!user) return;

      document.getElementById("editModal").style.display = "flex";
      document.getElementById("editUid").value = uid;
      document.getElementById("editEmail").value = user.email;
      
      const isPremium = user.subExpiryVal > Date.now();
      // If premium, show their specific plan. If free, show free.
      document.getElementById("editPlan").value = isPremium ? (user.planId || "standard_1m") : "free";

      const dateInput = document.getElementById("editDate");
      const dateGroup = document.getElementById("dateGroup");

      if(isPremium) {
          const d = new Date(user.subExpiryVal);
          dateInput.value = d.toISOString().split('T')[0];
          dateGroup.style.display = "block";
      } else {
          dateInput.value = "";
          dateGroup.style.display = "none";
      }
  };

  window.toggleDateInput = () => {
      const plan = document.getElementById("editPlan").value;
      document.getElementById("dateGroup").style.display = plan === "free" ? "none" : "block";
  };

  window.closeModal = () => { document.getElementById("editModal").style.display = "none"; };

  window.saveUserChanges = async () => {
      const uid = document.getElementById("editUid").value;
      const plan = document.getElementById("editPlan").value;
      const dateStr = document.getElementById("editDate").value;

      let newExpiry = 0;
      
      if(plan !== "free") {
          if(dateStr) { 
              const d = new Date(dateStr);
              d.setHours(23, 59, 59);
              newExpiry = d.getTime(); 
          } else { 
              // If they switched to premium but didn't pick date, give default 30 days
              newExpiry = Date.now() + (30 * 24 * 60 * 60 * 1000); 
          }
      } else {
          newExpiry = 0; // Reset to free
      }

      await updateDoc(doc(db, "users", uid), {
          subscriptionExpiry: newExpiry,
          planId: plan,
          paymentStatus: plan !== "free" ? "approved" : "none"
      });

      closeModal();
      alert("User updated successfully");
  };

  window.filterUsers = () => {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const filtered = globalUsers.filter(u => u.email.toLowerCase().includes(input));
      renderTable(filtered);
  };

</script>

</body>
</html>
